<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Einsatzzeitenrechner</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600&family=Source+Sans+Pro:wght@600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .form-row {
        display: flex;
        gap: 20px;
      }
      .form-row .form-group {
        flex: 1;
        margin-bottom: 0;
      }
      body {
        font-family: "Nunito Sans", Arial, sans-serif;
        background: #dae1e6;
        margin: 0;
        padding: 0;
        color: #616161;
      }
      .container {
        max-width: 800px;
        margin: 40px auto;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        padding: 30px;
        box-sizing: border-box;
        overflow: hidden;
      }
      .form-group input,
      .form-group select {
        box-sizing: border-box;
        max-width: 100%;
      }
      h1,
      h2 {
        text-align: center;
        font-family: "Source Sans Pro", sans-serif;
        color: #14212b;
        margin-bottom: 20px;
      }
      .progressbar {
        display: flex;
        justify-content: space-between;
        counter-reset: step;
        margin-bottom: 30px;
      }
      .progressbar li {
        list-style: none;
        text-align: center;
        position: relative;
        flex: 1;
        font-size: 14px;
        color: #616161;
        transition: all 0.3s ease;
      }
      .progressbar li:before {
        counter-increment: step;
        content: counter(step);
        width: 30px;
        height: 30px;
        line-height: 30px;
        border: 2px solid #77a4b2;
        display: block;
        text-align: center;
        margin: 0 auto 10px;
        border-radius: 50%;
        background: #fff;
        color: #14212b;
        font-weight: bold;
        transition: all 0.3s ease;
      }
      .progressbar li:after {
        content: "";
        position: absolute;
        width: 100%;
        height: 2px;
        background: #ccc;
        top: 15px;
        left: -50%;
        z-index: -1;
        transition: background 0.3s ease;
      }
      .progressbar li:first-child:after {
        content: none;
      }
      .progressbar li.active:before {
        border-color: #14212b;
        background: #77a4b2;
        color: #fff;
      }
      .progressbar li.active + li:after {
        background: #77a4b2;
      }
      .step {
        display: none;
      }
      .step.active {
        display: block;
      }
      .form-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #14212b;
      }
      input,
      select {
        width: 100%;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-family: "Nunito Sans", sans-serif;
        transition: all 0.3s ease;
      }
      input:focus,
      select:focus {
        border-color: #77a4b2;
        box-shadow: 0 0 4px rgba(119, 164, 178, 0.4);
        outline: none;
      }
      .buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
      }
      button {
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        background: #77a4b2;
        color: white;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
      }
      button:hover {
        background: #f5a97f;
        color: #14212b;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12);
      }
      .result-box {
        background: #f9fafb;
        padding: 20px;
        border-radius: 12px;
        margin-top: 20px;
        font-size: 1.1em;
        border: 1px solid #dae1e6;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
      }
      canvas {
        margin-top: 25px;
        max-width: 100%;
        border-radius: 12px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
      }
      p {
        text-align: center;
        font-size: 0.95em;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Einsatzzeitenrechner DGUV V2</h1>
      <ul class="progressbar">
        <li class="active" id="progress1">Daten</li>
        <li id="progress2">Berechnung</li>
        <li id="progress3">Ergebnis</li>
      </ul>
      <div class="step active" id="step1">
        <h2>Schritt 1: Unternehmensdaten</h2>
        <div class="form-group">
          <label>Vollzeit-Beschäftigte</label>
          <input type="number" id="fulltime" />
        </div>
        <div class="form-group">
          <label>Teilzeit > 20h</label>
          <input type="number" id="parttime20" />
        </div>
        <div class="form-group">
          <label>Teilzeit < 20h</label>
          <input type="number" id="parttime" />
        </div>

        <!-- Auswahlmodus -->
        <div class="form-group">
            <label>Wie möchten Sie Ihre Branche auswählen?</label>
            <div class="modern-radio-group">
              <label class="modern-radio-option">
                <input type="radio" name="mode" value="group" checked onchange="switchMode()" />
                <span>Betreuungsgruppe bekannt</span>
              </label>
              <label class="modern-radio-option">
                <input type="radio" name="mode" value="wz" onchange="switchMode()" />
                <span>WZ-Code bekannt</span>
              </label>
              <label class="modern-radio-option">
                <input type="radio" name="mode" value="branche" onchange="switchMode()" />
                <span>Übergeordnete Branche wählen</span>
              </label>
            </div>
        </div>

        <!-- Varianten -->
        <div id="mode-group" class="mode-container">
          <label>Betreuungsgruppe</label>
          <select id="group">
            <option value="2.5">Gruppe I (2,5 h)</option>
            <option value="1.5">Gruppe II (1,5 h)</option>
            <option value="0.5">Gruppe III (0,5 h)</option>
          </select>
        </div>

        <div id="mode-wz" class="mode-container" style="display: none">
          <label>WZ-Code</label>
          <select id="wzcode" onchange="updateGroupByWZ()"></select>
        </div>

        <div id="mode-branche" class="mode-container" style="display: none">
          <label>Übergeordnete Branche</label>
          <select id="branche" onchange="updateSubbranche()">
            <option value="">Bitte wählen</option>
            <option value="A">A – Land- und Forstwirtschaft, Fischerei</option>
            <option value="B">
              B – Bergbau und Gewinnung von Steinen und Erden
            </option>
            <option value="C">C – Verarbeitendes Gewerbe</option>
            <option value="D">D – Energieversorgung</option>
            <option value="E">
              E – Wasserversorgung, Abwasser- und Abfallentsorgung
            </option>
            <option value="F">F – Baugewerbe</option>
            <option value="G">G – Handel, KFZ</option>
            <option value="H">H – Verkehr und Lagerei</option>
            <option value="I">I – Gastgewerbe</option>
            <option value="J">J – Information und Kommunikation</option>
            <option value="K">K – Finanzdienstleistungen</option>
            <option value="L">L – Grundstücks- und Wohnungswesen</option>
            <option value="M">M – Freiberufliche Dienstleistungen</option>
            <option value="N">
              N – Sonstige wirtschaftliche Dienstleistungen
            </option>
            <option value="O">O – Öffentliche Verwaltung</option>
            <option value="P">P – Erziehung und Unterricht</option>
            <option value="Q">Q – Gesundheits- und Sozialwesen</option>
            <option value="R">R – Kunst, Unterhaltung</option>
            <option value="S">S – Sonstige Dienstleistungen</option>
          </select>

          <label>Spezifische Betriebsart</label>
          <select id="subbranche">
            <option value="">Bitte zuerst Branche wählen</option>
          </select>
        </div>

        <div class="buttons">
          <button onclick="nextStep(2)">Weiter</button>
        </div>
      </div>

      <div class="step" id="step2">
        <h2>Schritt 2: Berechnung starten</h2>
        <div class="buttons">
          <button onclick="prevStep(1)">Zurück</button>
          <button onclick="calculate()">Berechnen</button>
        </div>
      </div>

      <div class="step" id="step3">
        <h2>Schritt 3: Ergebnisse</h2>
        <div id="results" class="result-box"></div>
        <canvas id="chart" width="400" height="200"></canvas>
        <div class="buttons">
          <button onclick="prevStep(2)">Zurück</button>
          <button onclick="exportCSV()">Als CSV exportieren</button>
          <button onclick="exportPDF()">Als PDF exportieren</button>
        </div>
      </div>
    </div>

    <script>
      const { jsPDF } = window.jspdf;
      let chartInstance;

      // WZ-Code-Liste laden (z. B. aus JSON)
      fetch("BrachenData_flat.json")
        .then((r) => r.json())
        .then((data) => {
          const wzSelect = document.getElementById("wzcode");
          wzSelect.innerHTML = "";
          data.forEach((item) => {
            if (item.WZ_Code && item.Bezeichnung) {
              const option = document.createElement("option");
              option.value = item.WZ_Code;
              option.textContent = item.WZ_Code + " - " + item.Bezeichnung;
              wzSelect.appendChild(option);
            }
          });
        });

      function switchMode() {
        const mode = document.querySelector('input[name="mode"]:checked').value;
        document
          .querySelectorAll(".mode-container")
          .forEach((el) => (el.style.display = "none"));
        document.getElementById("mode-" + mode).style.display = "block";
      }

      function updateGroupByWZ() {
        const wz = document.getElementById("wzcode").value;
        // Hier kannst du die Gruppe automatisch setzen, falls gewünscht
        // z.B. document.getElementById("group").value = wzMapping[wz] || "";
      }

      function updateSubbranche() {
        const branche = document.getElementById("branche").value;
        const subSelect = document.getElementById("subbranche");
        subSelect.innerHTML = "";

        if (branche === "A") {
          const options = [
            {
              text: "01.5 Gemischte Landwirtschaft – Gruppe II – 1,5 h",
              value: "1.5",
            },
            { text: "02.1 Forstwirtschaft – Gruppe I – 2,5 h", value: "2.5" },
            { text: "02.2 Holzeinschlag – Gruppe I – 2,5 h", value: "2.5" },
            {
              text: "02.4 Dienstleistungen Forstwirtschaft – Gruppe I – 2,5 h",
              value: "2.5",
            },
          ];
          options.forEach((opt) => {
            let o = document.createElement("option");
            o.value = opt.value;
            o.textContent = opt.text;
            subSelect.appendChild(o);
          });
        } else {
          let o = document.createElement("option");
          o.textContent = "Noch keine Daten eingetragen";
          subSelect.appendChild(o);
        }
      }

      function nextStep(step) {
        document
          .querySelectorAll(".step")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById("step" + step).classList.add("active");
        for (let i = 1; i <= 3; i++)
          document.getElementById("progress" + i).classList.remove("active");
        document.getElementById("progress" + step).classList.add("active");
      }

      function prevStep(step) {
        nextStep(step);
      }

      function calculate() {
        let full = parseInt(document.getElementById("fulltime").value) || 0;
        let part20 = parseInt(document.getElementById("parttime20").value) || 0;
        let part = parseInt(document.getElementById("parttime").value) || 0;
        const mode = document.querySelector('input[name="mode"]:checked').value;

        let groupFactor = 1.5; // default
        if (mode === "group") {
          groupFactor = parseFloat(document.getElementById("group").value);
        } else if (mode === "wz") {
          groupFactor = parseFloat(document.getElementById("group").value); // später Mapping per WZ
        } else if (mode === "branche") {
          groupFactor = parseFloat(document.getElementById("subbranche").value);
        }

        let employees = full + part20 * 0.75 + part * 0.5;
        let totalHours = employees * groupFactor;
        let minHours = Math.max(0.2 * (full + part20 + part), totalHours * 0.2);
        let sifaHours = minHours;
        let doctorHours = totalHours - minHours;

        document.getElementById("results").innerHTML = `
    <strong>Beschäftigte (VZ-Äquivalent):</strong> ${employees.toFixed(2)}<br>
    <strong>Gesamtstunden Grundbetreuung:</strong> ${totalHours.toFixed(
      2
    )} h/Jahr<br>
    <strong>Betriebsarzt:</strong> ${doctorHours.toFixed(2)} h/Jahr<br>
    <strong>Fachkraft für Arbeitssicherheit:</strong> ${sifaHours.toFixed(
      2
    )} h/Jahr
  `;

        drawChart(sifaHours, doctorHours);
        nextStep(3);
      }

      function drawChart(sifa, arzt) {
        const ctx = document.getElementById("chart").getContext("2d");
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["Fachkraft für Arbeitssicherheit", "Betriebsarzt"],
            datasets: [
              {
                label: "Stunden",
                data: [sifa, arzt],
                backgroundColor: ["#77a4b2", "#f5a97f"],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
          },
        });
      }

      function exportCSV() {
        const full = document.getElementById("fulltime").value || 0;
        const part20 = document.getElementById("parttime20").value || 0;
        const part = document.getElementById("parttime").value || 0;
        const mode = document.querySelector('input[name="mode"]:checked').value;
        const group =
          mode === "branche"
            ? document.getElementById("subbranche").value
            : document.getElementById("group").value;
        const data = `Vollzeit,Teilzeit>20h,Teilzeit<20h,Betreuungsgruppe\n${full},${part20},${part},${group}`;
        const blob = new Blob([data], { type: "text/csv" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "einsatzzeiten.csv";
        link.click();
      }

      function exportPDF() {
        const doc = new jsPDF();
        doc.setFont("Nunito Sans");
        doc.setFontSize(16);
        doc.text("Einsatzzeitenrechner DGUV V2", 10, 20);
        const full = document.getElementById("fulltime").value || 0;
        const part20 = document.getElementById("parttime20").value || 0;
        const part = document.getElementById("parttime").value || 0;
        const mode = document.querySelector('input[name="mode"]:checked').value;
        const group =
          mode === "branche"
            ? document.getElementById("subbranche").value
            : document.getElementById("group").value;
        doc.setFontSize(12);
        doc.text(`Vollzeit-Beschäftigte: ${full}`, 10, 40);
        doc.text(`Teilzeit > 20h: ${part20}`, 10, 50);
        doc.text(`Teilzeit < 20h: ${part}`, 10, 60);
        doc.text(`Betreuungsgruppe: ${group}`, 10, 70);
        const resultText = document.getElementById("results").innerText;
        doc.text(resultText, 10, 90);
        doc.save("einsatzzeiten.pdf");
      }
    </script>
  </body>
</html>
